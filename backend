const express = require('express');
const sqlite3 = require('sqlite3').verbose();
const cors = require('cors');
const xml2js = require('xml2js');

const app = express();
app.use(cors());

// Middleware ะดะปั ะฟะฐััะธะฝะณะฐ XML
app.use(express.text({ type: 'application/xml' }));
app.use(express.json()); // ะดะปั JSON

const db = new sqlite3.Database('./resume_system.db');

// ะะฐััะตั XML
const xmlParser = new xml2js.Parser();
const xmlBuilder = new xml2js.Builder();

// ๐ค Endpoint ะดะปั ะญะะกะะะะขะ ะดะฐะฝะฝัั ะฒ XML
app.get('/candidates/xml', (req, res) => {
    const sql = `
        SELECT c.*, 
               GROUP_CONCAT(s.name) as skills
        FROM candidates c
        LEFT JOIN candidate_skills cs ON c.id = cs.candidate_id
        LEFT JOIN skills s ON cs.skill_id = s.id
        GROUP BY c.id
    `;
    
    db.all(sql, [], (err, rows) => {
        if (err) {
            res.status(500).json({ error: err.message });
            return;
        }
        
        // ะคะพัะผะธััะตะผ XML ััััะบัััั
        const xmlObject = {
            resumes: {
                candidate: rows.map(candidate => ({
                    id: candidate.id,
                    name: candidate.name,
                    email: candidate.email,
                    experience: candidate.experience,
                    skills: candidate.skills ? {
                        skill: candidate.skills.split(',').map(s => s.trim())
                    } : {}
                }))
            }
        };
        
        // ะะพะฝะฒะตััะธััะตะผ ะฒ XML
        const xml = xmlBuilder.buildObject(xmlObject);
        
        // ะัะฟัะฐะฒะปัะตะผ ะบะฐะบ XML
        res.set('Content-Type', 'application/xml');
        res.send(xml);
    });
});

// ๐ฅ Endpoint ะดะปั ะะะะะะขะ ะดะฐะฝะฝัั ะธะท XML
app.post('/candidates/import-xml', (req, res) => {
    const xmlData = req.body;
    
    xmlParser.parseString(xmlData, (err, result) => {
        if (err) {
            res.status(400).json({ error: 'ะะตะฒะฐะปะธะดะฝัะน XML' });
            return;
        }
        
        try {
            const candidates = result.resumes.candidate;
            let importedCount = 0;
            
            // ะะฑัะฐะฑะฐััะฒะฐะตะผ ะบะฐะถะดะพะณะพ ะบะฐะฝะดะธะดะฐัะฐ ะธะท XML
            candidates.forEach(candidateData => {
                const candidate = candidateData;
                
                const sql = `INSERT INTO candidates (name, email, experience) VALUES (?, ?, ?)`;
                const params = [
                    candidate.name[0],
                    candidate.email[0],
                    candidate.experience[0] || 0
                ];
                
                db.run(sql, params, function(err) {
                    if (err) {
                        console.error('ะัะธะฑะบะฐ ะดะพะฑะฐะฒะปะตะฝะธั:', err);
                    } else {
                        importedCount++;
                        
                        // ะะพะฑะฐะฒะปัะตะผ ะฝะฐะฒัะบะธ ะตัะปะธ ะพะฝะธ ะตััั
                        if (candidate.skills && candidate.skills[0].skill) {
                            const skills = candidate.skills[0].skill;
                            const candidateId = this.lastID;
                            
                            skills.forEach(skillName => {
                                // ะกะฝะฐัะฐะปะฐ ะฝะฐัะพะดะธะผ ะธะปะธ ัะพะทะดะฐะตะผ ะฝะฐะฒัะบ
                                db.get(
                                    "SELECT id FROM skills WHERE name = ?", 
                                    [skillName], 
                                    (err, skillRow) => {
                                        if (skillRow) {
                                            // ะกะฒัะทัะฒะฐะตะผ ะบะฐะฝะดะธะดะฐัะฐ ั ะฝะฐะฒัะบะพะผ
                                            db.run(
                                                "INSERT INTO candidate_skills (candidate_id, skill_id) VALUES (?, ?)",
                                                [candidateId, skillRow.id]
                                            );
                                        }
                                    }
                                );
                            });
                        }
                    }
                });
            });
            
            res.json({ 
                message: `ะะผะฟะพััะธัะพะฒะฐะฝะพ ${importedCount} ะบะฐะฝะดะธะดะฐัะพะฒ ะธะท XML` 
            });
            
        } catch (error) {
            res.status(500).json({ error: 'ะัะธะฑะบะฐ ะพะฑัะฐะฑะพัะบะธ XML' });
        }
    });
});

// ๐ค Endpoint ะดะปั ะฟะพะปััะตะฝะธั ะดะฐะฝะฝัั ะฒ XML ะธะปะธ JSON (ะฟะพ ะทะฐะณะพะปะพะฒะบั)
app.get('/candidates', (req, res) => {
    const acceptHeader = req.headers.accept;
    const format = req.query.format; // ะธะปะธ ัะตัะตะท query ะฟะฐัะฐะผะตัั
    
    const sql = `SELECT * FROM candidates`;
    
    db.all(sql, [], (err, rows) => {
        if (err) {
            res.status(500).json({ error: err.message });
            return;
        }
        
        // ะัะปะธ ะบะปะธะตะฝั ะทะฐะฟัะฐัะธะฒะฐะตั XML
        if (acceptHeader.includes('application/xml') || format === 'xml') {
            const xmlObject = {
                candidates: {
                    candidate: rows
                }
            };
            const xml = xmlBuilder.buildObject(xmlObject);
            res.set('Content-Type', 'application/xml');
            res.send(xml);
        } else {
            // ะะพ ัะผะพะปัะฐะฝะธั JSON
            res.json({ data: rows });
        }
    });
});

// ๐ฅ ะฃะฝะธะฒะตััะฐะปัะฝัะน endpoint (ะฟัะธะฝะธะผะฐะตั ะธ JSON ะธ XML)
app.post('/candidates', (req, res) => {
    let candidateData;
    
    // ะะฟัะตะดะตะปัะตะผ ัะธะฟ ะบะพะฝัะตะฝัะฐ
    const contentType = req.headers['content-type'];
    
    if (contentType.includes('application/xml')) {
        // ะะฐััะธะผ XML
        xmlParser.parseString(req.body, (err, result) => {
            if (err) {
                res.status(400).json({ error: 'ะะตะฒะฐะปะธะดะฝัะน XML' });
                return;
            }
            candidateData = result.candidate;
        });
    } else {
        // ะัะฟะพะปัะทัะตะผ JSON
        candidateData = req.body;
    }
    
    const { name, email, experience } = candidateData;
    
    const sql = `INSERT INTO candidates (name, email, experience) VALUES (?, ?, ?)`;
    const params = [name, email, experience || 0];
    
    db.run(sql, params, function(err) {
        if (err) {
            res.status(500).json({ error: err.message });
            return;
        }
        res.json({
            message: "ะะฐะฝะดะธะดะฐั ะดะพะฑะฐะฒะปะตะฝ",
            data: { id: this.lastID, name, email, experience }
        });
    });
});

app.listen(3000, () => {
    console.log('๐ ะกะตัะฒะตั ั XML ะฟะพะดะดะตัะถะบะพะน ะทะฐะฟััะตะฝ ะฝะฐ ะฟะพััั 3000');
});
